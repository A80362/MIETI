DELIMITER //
create function empregado(cod_funcionario int)   									/*verifica se o empregado existe, funciona*/
returns bool
begin
	declare code int;
	declare fim_em date;
	select codigo,data_terminacao
	into code,fim_em
	from funcionario
	where codigo = cod_funcionario;
	if (((code is null) and (fim_em is null)) or (fim_em is not null)) then          							/*se o empregado existe, é retornado o valor 1*/
		return (false);
	else
		return (true);
	end if;
end //
DELIMITER ;

DELIMITER //
create function existe_material(material varchar(20))   				/*verifica a existencia de um material,funcina*/
returns bool
begin
	declare mater varchar(20);
	select tipo_material
	into mater
	from material
	where tipo_material = material;
	if (mater is null) then        
		return (false);
	else
		return (true);
	end if;
end //
DELIMITER ;

DELIMITER //        								 /*retorna o numero de veiculos que nao possuem itinerario*/
CREATE FUNCTION veiculos_sem_it()     						/*está a funcionar*/
returns int
begin
	declare num_viaturas int;
	declare viaturas_usadas int;
	declare mat varchar(10);
	select COUNT( * )
	into num_viaturas
	from viatura;
	
	select COUNT(distinct matricula)  
	into viaturas_usadas
	from viagem;
	return(num_viaturas-viaturas_usadas);
end //
DELIMITER ;


DELIMITER //         											/*Indica quantos itenerários um veículo faz */
CREATE FUNCTION quantas_viagens(matr varchar(10))     				/*está a funcionar*/
returns int
begin
	declare mat varchar(10);
	declare numero_itinerarios int;

	select matricula
	into mat
	from viatura
	where matricula=matr;

	select COUNT(distinct cod_rota,matricula,data,hora)
	into numero_itinerarios
	from viagem
	where mat=matricula;
	return (numero_itinerarios);
end //
DELIMITER ;

DELIMITER //
create function get_numero_codigos_itinerario()  /* está a funcionar */
returns int
begin
	declare num_codigos int;
	select COUNT(distinct cod_rota) /*NÃO ENTENDI O QUE CRLH ISTO FAZ*/ 
	into num_codigos
	from funcionarios_viagem;
	return (num_codigos);
end //
DELIMITER ;


DELIMITER //
create function mais_funcionarios()    						/*retorna o num de funcionarios da rota com mais funcionario*/
returns int
begin
	declare num_codigos int;         							/*quantidade de funcioanrios em itinerario*/ 
     declare quantos int;

	set num_codigos = get_numero_Codigos_itinerario();

	select COUNT(distinct cod_func) 	
	into quantos
	from funcionarios_viagem
	group by num_codigos;
	return(quantos);   															/*retorna o numero de funcionario*/
 end //	
 DELIMITER ;

/*DELIMITER //
create function return_codigo_itinerario(quantos int)     /*retornar o código do itinerario, nao está a funcionar */
/*eturns int 
begin
	declare code int;
	declare num_func int;
	select cod_itinerario,COUNT(distinct cod_func)
	into code,num_func
	from itinerario
	where num_func=quantos;
	return num_func;
end //	*/


DELIMITER //
create function nascimento_func(cod_funcionario int)   /*retorna a data de nascimento de um determinado funcionario, funciona*/
returns date
begin
	declare data  date;
	select data_nascimento
	into data
	from funcionario
	where codigo = cod_funcionario;
	return (data);
end //
DELIMITER ;


DELIMITER //
create function lucro_vendas_material(buyer varchar(20))   /*retorna o ganho que se ganhou com um determinado compraduor*/
returns decimal(4,2)       
begin
	declare codigo_material int;
	declare valor decimal(10,2);
	declare total decimal(10,2); 

	select SUM(preco)
	into total
	from venda
	where comprador = buyer;
	
	return (total); 
end //  
DELIMITER ;

/*DELIMITER //
create function lucro_venda(lote int,numero_venda int, quantidade decimal(10,2))    /* retorna o lucro de uma avenda e completa a tabela, cujo valor está a null*/
/*returns decimal(10,2)	
begin
	declare vender_kg decimal(4,2);
	declare preco_da_venda decimal (10,2);
	declare lucro_obtido decimal (10,2);
	select preco_kg
	into vender_kg
	from material
	where lote=cod_lote;

	set preco_da_venda=quantidade*vender_kg;
	set lucro_obtido=preco_da_venda-preco_da_venda*0.23;

	if exists
		(select* from venda
			where num_venda=numero_venda) then
			update venda
				set lucro=lucro_obtido
				where num_venda=numero_venda;
	end if;
	return(lucro_obtido);
end // */

DELIMITER //       
create function func_veiculo(matricul varchar(10),cod_funcionario int)
returns bool
begin
	declare rota_em_que_andou_este_veiculo int;
	declare rota_em_que_andou_o_func int;

	select cod_rota 
	into rota_em_que_andou_este_veiculo
	from viagem
	where matricula = matricul;
	select cod_rota 
	into rota_em_que_andou_o_func
	from funcionarios_viagem
	where cod_func = cod_funcionario ;
	/*
		O QUE ESTA FUNCAO FAZ É DIZ SE ELES ANDARAM NA MESMA ROTA, NO ENTANTO SE UM CAMIAO ANDAR NA ROTA E 20 DIAS DEPOIS O GAJO ANDAR NESSA ROTA ISTO FAZ RETURN TRUE... */
	if (rota_em_que_andou_o_func = rota_em_que_andou_este_veiculo) then
		return (true);
	else
		return (false);	
	end if;
end //
DELIMITER ;

