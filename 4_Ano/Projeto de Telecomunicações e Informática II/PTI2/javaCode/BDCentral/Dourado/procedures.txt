


DELIMITER //
create procedure registarFunc(in nome varchar(20),in morada varchar(50),in nif varchar(9),in data_nasc date, in data_cont date,in telef char(9))
begin
	declare data_atual date;
	declare dif int;  
	declare dif_ano decimal(10,2);

	if exists
		(select* from funcionario
		where NIF=nif) then 
		update funcionario
			set telefone=telef,
				morada = morada,
				NIF = NIF,
				data_nascimento = data_nasc
			where telefone=telef;
	else		
		set data_atual=curdate();
		set dif=datediff(data_atual,data_nasc); 

		set dif_ano=dif/365;
		if(dif_ano>18) then
			insert into funcionario(nome,morada,NIF,data_nascimento,data_contratacao,telefone)
			values(nome,morada,NIF,data_nasc,data_cont,telef);
		end if;	
	end if;
end //	
DELIMITER ;

DELIMITER //
create procedure registar_viatura(in mat varchar(10), in tipo varchar(20), in quilometros int)
begin
	if exists
		(select* from viatura
			where matricula=mat) then
			update viatura
				set matricula=mat,
					tipo_viatura=tipo,
					kms=quilometros
				where matricula=mat;	
	else
		insert into viatura(matricula,tipo_viatura,kms)
		values(mat,tipo,quilometros);
end //
DELIMITER ;

DELIMITER //
create procedure registar_local(in morada varchar(50),in telef char(9),in resp varchar(20))
begin
	insert into local_recolha(morada,telef_resp,nome_resp)
	values(morada,telef,resp);
end //
DELIMITER ;	

DELIMITER //
create procedure registar_pedido_recolha(in moradae varchar(50),in data date,in hora time,in telef char(9),in informacao varchar(100), in peso int, in nome varchar(20))
begin 

	declare nothing int;
	if exists
		( select* from local_recolha
				where morada = moradae) then
		select peso
		into nothing;
	else
		call registar_local(moradae,telef,nome);
	end if;

	insert into pedido_recolha(morada,data_pedido,hora_pedido,telef_resp,informacao,peso_recolha)
	values(moradae,data,hora,telef,informacao,peso);
end //
DELIMITER ;


DELIMITER //
create procedure registar_itinerario(in i varchar(50),in f varchar(50),in rota int,in dist decimal(4,2))
begin 
	declare nothing int;

	if exists
		(select* from rota
			where cod_rota = rota) then

		select rota
		into nothing;
	else
		insert into rota(cod_rota)
		values(rota);
	end if;
	insert into itinerario(morada_inicial,morada_final,cod_rota,distancia)
	values(i,f,rota,dist);
end //	
DELIMITER ;

DELIMITER //
create procedure registar_viagem(in rota int, in matricula varchar(10), in data date, in hora time, in cod_funcMain int, in cod_func2 int, in cod_func3 int)
begin
	if exists
		(select* from viagem
			where cod_rota != rota) then
			insert into viagem(cod_rota,matricula,data,hora)
				values(rota,matricula,data,hora);
				call RegistarFuncionariosViagem(rota,cod_funcMain);
				call RegistarFuncionariosViagem(rota,cod_func2);
				call RegistarFuncionariosViagem(rota,cod_func3);
	end if;			
end //

DELIMITER //
create procedure RegistarFuncionariosViagem(in cod_rt int,in cod_f int)
begin
	insert into funcionarios_viagem(cod_rota,cod_func)
	values(cod_rt,cod_f);
end //	
DELIMITER ;	

DELIMITER //
create procedure registar_lote_material( in quantidade decimal(4,2), in material varchar(20),in preco_kg decimal(4,2))
begin 
	if exists
		(select* from material
		where tipo_material=material) then 
		update material
			set quantidade=quantidade,
			tipo_material=material,
			preco_kg=preco_kg
			where cod_lote=cod_lote;
	end if;	
			insert into material(quantidade,tipo_material,preco_kg,data_eliminacao)
		values(quantidade, material,preco_kg,null);
end //
DELIMITER ;

DELIMITER //
create procedure registar_venda(in cod int,in comprador varchar(30))
begin
	declare nothing int;
	declare qtd decimal(4,2);
	declare preco decimal(4,2);
	declare data date;

	set data = curdate();

if exists
	(select* from venda
	where cod_lote = cod) then
	select 0
	into nothing;
	else
		select quantidade
		into qtd
		from material
		where cod_lote = cod;

		select preco_kg
		into preco
		from material
		where cod_lote =cod;

		insert into venda(cod_lote,preco,comprador)
		values(cod,qtd*preco,comprador);

		update material
			set data_eliminacao = data
		where cod_lote = cod;
	end if;
end //
DELIMITER ;

DELIMITER //
create procedure registar_processo(in nome varchar(20),in descr varchar(100))
begin 
	insert into processo(nome_processo,descricao)
	values(nome,descr);
end //	
DELIMITER ;	

DELIMITER //
create procedure registar_etapa(in nome_pros varchar(20),in cod_func int, in cod_lote int, in data_etapa date, in hora_inicial time)
begin 
	insert into etapa(nome_processo,cod_func,cod_lote,data_etapa,hora_inicio,hora_fim)
	values(nome_pros,cod_func,cod_lote,data_etapa,hora_inicial,null);
end //
DELIMITER ;




DELIMITER // 
create procedure despedir_funcionario(in codigoIN int, in data_hoje date)
	begin
		update funcionario
			set data_terminacao = data_hoje
			where codigo = codigoIn;
end //
DELIMITER ;



DELIMITER //
create procedure registar_fim_etapa(in cod_lotee int, in data_i date, in hora_i time, in hora time)
	begin
		update etapa
			set hora_fim = hora
			where data_etapa = data_i and hora_inicio = hora_i and cod_lote = cod_lotee;
end //
DELIMITER ;

DELIMITER //
create procedure eliminar_lote(in cod int)
	begin
	declare data date;
	declare datanull date;
	declare nothing int;
	set data = curdate();

	select data_eliminacao
	into datanull
	from material
	where cod_lote = cod;


	if(datanull > '1000-01-01')
	then
		set nothing = 0;

	else
		update material
			set data_eliminacao = data
			where cod_lote = cod;

	end if;
end //
DELIMITER ;


DELIMITER // 
create procedure dividir_lote(in cod int,in qt1 decimal(4,2), in qt2 decimal(4,2))
	begin
	declare quantidadeini decimal(4,2);
	declare tipo_ini varchar(20);
	declare preco_kgini decimal(4,2);
	declare datanull date;
	declare data date;
	declare nothing int;

	set data = curdate();

	select quantidade,tipo_material,preco_kg,data_eliminacao
	into quantidadeini,tipo_ini,preco_kgini,datanull
	from material
	where cod_lote = cod;

	if (quantidadeini = qt1+qt2)

	then 
			if(datanull > '1000-01-01')
			then

				set nothing = 0;

			else
					call eliminar_lote(cod);
					call registar_lote_material(qt1,tipo_ini,preco_kgini);
					call registar_lote_material(qt2,tipo_ini,preco_kgini);
			end if;
	end if;

	select * from material;
end//
DELIMITER ;

DELIMITER //
	create procedure determinar_agendamentos(in telef char(9))	/*agendamentos realizados nos últimos 7 dias por um responsável*/
	Begin
	declare counter int;
	declare ret int;
	declare hoje date;

	set hoje=curdate();
	set ret=0;
	if exists
		(select* from pedido_recolha
		where telef_resp=telef) then 
			
			select COUNT(*)
			into counter
			from pedido_recolha
			where((datediff(hoje,data_pedido))<7);	
			select* from pedido_recolha where telef_resp=telef;
	end if;
end //	
DELIMITER ;

