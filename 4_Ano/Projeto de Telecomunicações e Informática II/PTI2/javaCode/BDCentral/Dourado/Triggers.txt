DELIMITER //
	create trigger verificar_agendamento_recolha								/*se um derminado responsável já realizaou 7 pediddos de recolha nos útlimmos 7 dias*/
	before insert on pedido_recolha												/* fica limitado a que a próxima recolha tenha no máximo 20 kg      */		
	for each row
	Begin
	declare peso int;
	declare hoje date;
	declare quantos_pedidos_realizados int;

	set hoje=curdate();
	set peso=100;
	if exists
		(select* from pedido_recolha
		where telef_resp=new.telef_resp) then 
			
			select COUNT(*)
			into quantos_pedidos_realizados
			from pedido_recolha
			where((datediff(hoje,data_pedido))<7);										/*  determina o numero de pedidos dos ultimos 7 dias  */

				if (quantos_pedidos_realizados>7 and new.peso_recolha>100) then
						set new.peso_recolha=peso;
					     
				end if;	
	end if;		
end //	
DELIMITER ;

DELIMITER //
	create trigger atualizar_kms
	after insert on viagem
	for each row
	Begin
	declare rota int;
	declare kms_um_itinerario decimal (8,2);

	select cod_rota
	into rota
	from viagem
	where matricula=new.matricula;

	select SUM(distancia)
	into kms_um_itinerario
	from itinerario
	where cod_rota=rota;

	update viatura
		set kms=kms+kms_um_itinerario
		where matricula=new.matricula;	
end //
DELIMITER ;



